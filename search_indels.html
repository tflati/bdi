<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"> 
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="bower_components/angular-material/angular-material.css">

		<script src="bower_components/angular/angular.js"></script>
		<script src="bower_components/angular-aria/angular-aria.js"></script>
		<script src="bower_components/angular-animate/angular-animate.js"></script>
		<script src="bower_components/angular-material/angular-material.js"></script>

		<script src="bower_components/chart.js/dist/Chart.js"></script>
		<script src="bower_components/angular-chart.js/angular-chart.js"></script>
		
		<!-- TABLES -->
		<link href="bower_components/angular-material-data-table/dist/md-data-table.min.css" rel="stylesheet" type="text/css"/>
		<script src="bower_components/angular-material-data-table/dist/md-data-table.js" type="text/javascript"></script>

		<style>
				.md-table tbody tr{
					transition: all 0.1s ease-in;
				}
				.md-table tbody tr:hover {
				  cursor:pointer;
				  background-color:rgba(63,81,181,0.2);
				}

				#toolbar {
					background-color: #efefef;
				}
		</style>

		<script>

			angular.module( 'app', [ 'ngMaterial', 'chart.js', 'md.data.table'] )
				.config(function($mdThemingProvider) {
					$mdThemingProvider.theme('big-data-theme')
					      .primaryPalette('amber')
					      .accentPalette('red')
					      .warnPalette('light-green');
				})
				.controller("controller", function($http, $scope, $mdDialog, $timeout, $mdSidenav){

					self = this;
					
					self.info = {};

					$http.get('search_indels.json').then(function(response) {
                        self.info = response.data;
                        console.log(response);
                        
                        var selectIndex = 0;
                        for(var i=0; i<self.info.form.fields.length; i++)
                        {
                        	var field = self.info.form.fields[i];
                        	console.log("FORM FIELD: ", field);
                        	
                        	if(field.type === "checkbox" && field.value === "true")
                        	{
                        		field.checked = true;
                        	}
                        	else if(field.type === "select")
                        	{
                        		selectIndex = i;
                        		
                        		$http.get(field.values).then(function(response) {
                        			console.log("SELECT VALUES:",response);
                        			console.log("SELECT INDEX:", selectIndex);
                        			
                        			var selectField = self.info.form.fields[selectIndex];
                        			selectField.values = response.data;
                        			console.log("NEW VALUES A: ", selectField);
                        			console.log("NEW VALUES B: ", self.info.form.fields[selectIndex]);
                        		}, function(response){console.log("COULD NOT GET VALUES FOR SELECT FIELD");});
                        	}
                        }
                        
                	}, function(response){
                		console.log("ERROR GETTING THE CONFIG FILE");
                	});
					
					self.print = function(){
						console.log(self.info.form);
					};
					
					self.send_query = function(){
						var args = [];
						for(var i=0; i<self.info.form.fields.length-1; i++)
						{
							var field = self.info.form.fields[i];
							var value = field.value;
							args.push(value);
						}
						
						console.log(args);
						
						$http.get(self.info.form.submit.url + args.join("/")).then(function(response) {
							console.log("QUERY SUCCESS", response);
							self.data = response.data.details;
							
						}, function(response){ console.log("ERROR WHILE SENDING QUERY...", response);});
					};
	
				}// End of controller
			);

		</script>
	</head>
	<body style="margin: 0px; font-size: 1.2em;" ng-app="app" md-theme="big-data-theme">

		<div ng-controller="controller as ctrl" layout="column" ng-cloak>

			<md-toolbar class="md-menu-toolbar" id="toolbar">
				<div layout="row">
				  <div>
					<md-menu-bar>
					  <md-menu ng-repeat="item in ctrl.info.menu">
					    <button ng-click="$mdOpenMenu()">
					      {{item.name}}
					    </button>
					    <md-menu-content>
							<md-menu-item ng-repeat="subitem in item.items">
							    <md-button>
							      {{subitem.name}}
							    </md-button>
							</md-menu-item>
						</md-menu-content>
					  </md-menu>
					</md-menu-bar>
				  </div>
				</div>
			  </md-toolbar>
	
			<section layout="row" flex>
	
				<md-content flex layout-padding>
					<md-card layout="row">
						<img flex="{{ctrl.info.image.percentage_width}}" ng-src="{{ctrl.info.image.src}}" class="md-card-image">
	
						<md-card-title layout="column" flex="50">
							<md-card-title-text layout="column">
								<span class="md-headline" style="font-size: 2em;" ng-bind="ctrl.info.title"></span>
								<span class="md-subhead" ng-bind="ctrl.info.description"></span>
								<md-card-title-media layout="row" flex="auto" layout-padding>
									<img class="md-media-sm" style="height:100px;" ng-src="http://galaxy.cineca.it/micco/fusion-form/app/assets/logo_cineca.png" alt="logo1">
									<img class="md-media-sm" style="height:100px; width:300px;" ng-src="http://irpa-c02.kxcdn.com/wp-content/uploads/2013/05/LOGO-Tuscia.jpg" alt="logo2">
							</md-card-title-media>
							</md-card-title-text>
						</md-card-title>
				      </md-card>
	
				    </md-content>
			</section>
	
			<section style="padding: 0% 5% 0% 5%;">
				<p>{{ctrl.info.long_description}}</p>
				
				<form ng-submit="ctrl.send_query()">
					<div ng-repeat="field in ctrl.info.form.fields">
						<md-input-container>
							<label style="min-width: 400px;" ng-if="field.type != 'checkbox'" ng-bind="field.label"></label>
							<input ng-if="field.type != 'select' && field.type != 'checkbox'" ng-model="field.value" ng-checked="{{field.checked}}" ng-value="{{field.default}}" type="{{field.type}}" />
							<md-select ng-model="field.value" ng-if="field.type == 'select'" ng-model-options="{trackBy: '$value.id'}">
								<md-option ng-value="value" ng-repeat="value in field.values">{{value}}</md-option>
							</md-select>
							<md-checkbox ng-if="field.type == 'checkbox'" ng-model="field.value" ng-checked="{{field.checked}}">
								{{field.label}}
							</md-checkbox>
						</md-input-container>
					</div>
					<input type="submit" ng-value="ctrl.info.form.submit.label">
				</form>
				<button ng-click="ctrl.print()">Print</button>
			</section>

		<table md-table md-row-select multiple>
			<thead md-head>
				<tr md-row>
					<th md-column ng-repeat="col in ctrl.data.header"><span>{{col}}</span></th>
				</tr>
			</thead>
			<tbody md-body>
				<tr md-row md-auto-select ng-repeat="row in ctrl.data.items">
					<td md-cell ng-repeat="field in row">
						<span>{{field.value}}</span></td>
				</tr>
			</tbody>
		</table>

	</div>
	</body>
</html>
