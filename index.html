<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="stylesheet"
	href="bower_components/angular-material/angular-material.css">

<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/angular-aria/angular-aria.js"></script>
<script src="bower_components/angular-animate/angular-animate.js"></script>
<script src="bower_components/angular-material/angular-material.js"></script>

<script src="bower_components/chart.js/dist/Chart.js"></script>
<script src="bower_components/angular-chart.js/angular-chart.js"></script>

<!-- TABLES -->
<link
	href="bower_components/angular-material-data-table/dist/md-data-table.min.css"
	rel="stylesheet" type="text/css" />
<script
	src="bower_components/angular-material-data-table/dist/md-data-table.js"
	type="text/javascript"></script>

<style>
.md-table tbody tr {
	transition: all 0.1s ease-in;
}

.md-table tbody tr:hover {
	cursor: pointer;
	background-color: rgba(63, 81, 181, 0.2);
}

#toolbar {
	background-color: #efefef;
}
</style>

<script>

			angular.module( 'app', [ 'ngMaterial', 'chart.js', 'md.data.table'] )
				.config(function($mdThemingProvider) {
					$mdThemingProvider.theme('big-data-theme')
					      .primaryPalette('amber')
					      .accentPalette('red')
					      .warnPalette('light-green');
				})
				.controller("controller", function($http, $scope, $mdDialog, $timeout, $mdSidenav){

					self = this;
					
					self.page = 'templates/main.html';
					self.info = {};
					self.header = {show_logos: true};
					
					self.form;
					
					self.print = function(){
						console.log(self.info.forms);
					};
					
					self.load_form = function(group, option){
						
						// Remove previous form inputs...
						for(var f=0; f<self.form.fields.length;)
						{
							//console.log("FORM FIELD: ", f, self.form.fields[f]);
							
							if(self.form.fields[f].parent_group_id == group.group_id)
							{
								//console.log("Removing form field " + f, self.form.fields[f]);
								// toRemove.push(f);
								self.form.fields.splice(f, 1);
							}
							else f++;
						}
						
						// ... and add newly selected form inputs
						for(var f=0; f<option.form.fields.length; f++)
						{
							// console.log("Adding form field " + f, option.form.fields[f]);
							option.form.fields[f].parent_group_id = group.group_id;
							var newForm = option.form.fields[f];
							
							self.form.fields.push(newForm);
							
							/*
							if(newForm.type === "checkbox" && newForm.value === "true")
                        	{
								newForm.checked = true;
                        	}
                        	else if(newForm.type === "select")
                        	{
                        		selectIndex = f;
                        		
                        		console.log("GETTING VALUES FOR SELECT: " + newForm.values);
                        		
                        		$http.get(newForm.values).then(function(response) {
                        			console.log("SELECT VALUES:",response);
                        			console.log("SELECT INDEX:", selectIndex);
                        			
                        			var selectField = option.form.fields[selectIndex];
                        			selectField.values = response.data;
                        			console.log("NEW VALUES A: ", selectField);
                        			console.log("NEW VALUES B: ", option.form.fields[selectIndex]);
                        		}, function(response){console.log("COULD NOT GET VALUES FOR SELECT FIELD", response);});
                        	}
							*/
						}
					};
					
					self.goTo = function(url){
						console.log("Want to go to " + url);
						
						// Check if the url is a form name
						var isForm = false;
						for(var f=0; f<self.info.forms.length; f++)
						{
							var form = self.info.forms[f];
							if(form.name == url)
							{
								isForm = true;
								self.form = form;
								
								console.log(self.form);
								
								break;
							}
						}
						
						if(isForm) {
							self.page = 'templates/form.html';
							self.info.image.percentage_width = 10;
							self.header.show_logos = false;
						}						
						else window.location = url;
					};
					
					self.send_query = function(){
						var args = [];
						for(var i=0; i<self.info.forms.fields.length-1; i++)
						{
							var field = self.info.forms.fields[i];
							var value = field.value;
							args.push(value);
						}
						
						console.log(args);
						
						$http.get(self.info.forms.submit.url + args.join("/")).then(function(response) {
							console.log("QUERY SUCCESS", response);
							self.data = response.data.details;
							
						}, function(response){ console.log("ERROR WHILE SENDING QUERY...", response);});
					};
					
					self.ajax2forms = [];

					$http.get('fusion.json').then(function(response) {
                        self.info = response.data;
                        console.log(response);
                        
                        for(var f=0; f<self.info.forms.length; f++)
                        {
                        	var form = self.info.forms[f];
                        	
	                        for(var i=0; i<form.fields.length; i++)
	                        {
	                        	var field = form.fields[i];
	                        	
	                        	// Assign the chosen default value
	                        	if(field.default) field.value = field.default;
	                        	
	                        	// Check types
	                        	if(field.type == "number") field.value = parseInt(field.value);
	                        	
	                        	if(field.type === "checkbox" && field.value === "true")
	                        	{
	                        		field.checked = true;
	                        	}
	                        	else if(field.type === "select")
	                        	{
	                        		var ajaxForms = self.ajax2forms[field.values];
	                        		if( !ajaxForms ) {ajaxForms = []; self.ajax2forms[field.values] = ajaxForms;}
	                        		ajaxForms.push(field);
	                        	}
	                        	
	                        	// Subform handling 
	                        	if(field.form) {
	                        		// console.log("Handling subforms");
	                        		for(var j=0; j < field.form.length; j++)
	                        		{	
	                        			var subform = field.form[j];
// 	                        			console.log("SUBFORM: ", subform);
	                        			
	                        			for(var s=0; s<subform.fields.length; s++)
	                        			{
	                        				var subfield = subform.fields[s];
// 	                        				console.log("\tSUBFORM FIELD", subfield);
	                        				if(subfield.type == "select") {
	                        					console.log("FOUND SUBSELECT", subfield);
			                        			var ajaxForms = self.ajax2forms[subfield.values];
				                        		if( !ajaxForms ) {ajaxForms = []; self.ajax2forms[subfield.values] = ajaxForms;}
				                        		ajaxForms.push(subfield);
		                        			}
	                        			}
	                        			
	                        			// console.log("Handling subform = ", subform);
	                        			
		                        		if(!subform.value && !subform.index) continue;
		                        		
		                        		// console.log("\tsubform= ", subform.value, subform.index, field.values);
		                        		
	                        			for(var c=0; c < field.values.length; c++)
	            						{
	            							var value = field.values[c];
	            							// console.log("\t\tvalue=", value);
	            							
	            							if(subform.value && value.label == subform.value)
	            							{
	            								// console.log("\tsubform's name="+subform.value+" equals name of option="+value);
	            								value.url = subform.name;
	            								value.form = subform;
	            							}
	            							else if(subform.index && c == subform.index)
	            							{
	            								value.url = subform.name;
	            								value.form = subform;
	            							}
	            						}
	                        		}
	                        	}
	                        }
                        }
                        
                        console.log("ajax2forms", self.ajax2forms);
                        
                        // Make all the ajax calls here
                        for(var key in self.ajax2forms)
                        {
                        	console.log("GETTING VALUES FOR SELECT: " + key);	                        		
                    		$http.get(key).then(
                    				function(response) {
   	                        			console.log("RESPONSE", response);
   	                        			console.log("FORMS AFFECTED", self.ajax2forms[response.config.url]);
//    	                        			console.log("ajax2forms", self.ajax2forms);
//    	                        			console.log("self", self);
//    	                        			console.log("url", response.config.url);
//    	                        			console.log("form chosen", self.ajax2forms[response.config.url]);

										var affectedForms = self.ajax2forms[response.config.url]
										for(var formId in affectedForms)
											affectedForms[formId].values = response.data;
//    	                        			console.log("form chosen after", self.ajax2forms[response.config.url]);
                            			
                            			// var selectField = self.form.fields[self.formIndex];	                        			
                            			// selectField.values = response.data;
                            			// console.log("NEW VALUES A: ", selectField);
                            			// console.log("NEW VALUES B: ", self.info.forms.fields[selectIndex]);
                            		},
                            		function(response){
                            			console.log("COULD NOT GET VALUES FOR SELECT FIELD", response);
                            			var affectedForms = self.ajax2forms[response.config.url]
										for(var formId in affectedForms)
											affectedForms[formId].values = ["NOT AVAILABLE"];
                            		}
                            );
                        }
                        
                	}, function(response){
                		console.log("ERROR GETTING THE CONFIG FILE");
                	});
					
					$scope.toggle = function() {
					      return $mdSidenav('left').toggle();
					    }
					
				  $scope.chartlabels = ["January", "February", "March", "April", "May", "June", "July"];
				  $scope.chartseries = ['Series A', 'Series B'];
				  $scope.chartdata = [
					[65, 59, 80, 81, 56, 55, 40],
					[28, 48, 40, 19, 86, 27, 90]
				  ];
				  $scope.onClick = function (points, evt) {
					console.log(points, evt);
				  };
				  $scope.datasetOverride = [{ yAxisID: 'y-axis-1' }, { yAxisID: 'y-axis-2' }];
				  $scope.options = {
					scales: {
					  yAxes: [
						{
						  id: 'y-axis-1',
						  type: 'linear',
						  display: true,
						  position: 'left'
						},
						{
						  id: 'y-axis-2',
						  type: 'linear',
						  display: true,
						  position: 'right'
						}
					  ]
					}
				  };

				  $scope.pielabels = ["chr1", "chr2", "chr3", "chr4", "chr5", "chr6", "chr7", "chr8", "chr9", "chr10", "chr11", "chr12", "chr13", "chr14", "chr15", "chr16", "chr17", "chr18", "chr19", "chr20", "chr21", "chr22", "chr23", "chr24", "chr25", "chr26", "chr27", "chr28", "chr29", "chrX"];
				  $scope.piedata = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
				  $scope.pieclick = function(evt)
				  {
					    var chr = $scope.pielabels[evt[0]._index];
						$mdDialog.show(
							  $mdDialog.alert()
								.clickOutsideToClose(true)
								.title('Cromosoma: ' + chr)
								.textContent('Questa funzione non è stata ancora implementata.')
								.ariaLabel('Chromosome info')
								.ok('Ho capito!')
								.openFrom({
								  top: -50,
								  width: 30,
								  height: 80
								})
								.closeTo({
								  left: 1500
								})
							);
				  };
				  $scope.pieoptions = {fontSize: 200};

				  $scope.histlabels = ['2006', '2007', '2008', '2009', '2010', '2011', '2012'];
				  $scope.histseries = ['Series A', 'Series B'];
			      $scope.histdata = [
					  [65, 59, 80, 81, 56, 55, 40],
					  [28, 48, 40, 19, 86, 27, 90]
					];

			      $http.get("http://localhost/api/app/show_info/Accession_number_peach_1.csv").then(function(response){
                                   console.log("SUCCESS IN GETTING STATISTICS_ALL");
				   console.log(response.data);
				   $scope.data = response.data.details;

				}, function myError(response) {
									console.log(response);
                                   console.log("ERROR IN GETTING STATISTICS_ALL");
				 //console.log(response);
    				});

				  this.settings = {
					  printLayout: true,
					  showRuler: true,
					  showSpellingSuggestions: true,
					  presentationMode: 'edit'
					};

					this.sampleAction = function(name, ev) {
					  $mdDialog.show($mdDialog.alert()
						.title(name)
						.textContent('You triggered the "' + name + '" action')
						.ok('Great')
						.targetEvent(ev)
					  );
					};
				}// End of controller
			);

		</script>
</head>
<body style="margin: 0px; font-size: 1.2em;" ng-app="app"
	md-theme="big-data-theme">

	<div ng-controller="controller as ctrl" layout="column" ng-cloak>

		<md-toolbar class="md-menu-toolbar" id="toolbar">
		<div layout="row">
			<div>
				<md-menu-bar> <md-menu
					ng-repeat="item in ctrl.info.menu">
				<button ng-click="item.items ? $mdOpenMenu() : ctrl.goTo(item.url)">
					{{item.name}}</button>
				<md-menu-content> <md-menu-item
					ng-repeat="subitem in item.items"> <md-button
					ng-click="ctrl.goTo(subitem.url)"> {{subitem.name}} </md-button> </md-menu-item> </md-menu-content>
				</md-menu> </md-menu-bar>
			</div>
		</div>
		</md-toolbar>

		<section layout="row" flex>
			<md-content flex layout-padding> <md-card layout="row">
			<img flex="{{ctrl.info.image.percentage_width}}"
				ng-src="{{ctrl.info.image.src}}" class="md-card-image"> <md-card-title
				layout="column" flex="{{100-ctrl.info.image.percentage_width}}">
			<md-card-title-text layout="column"> <span
				class="md-headline" style="font-size: 2em;"
				ng-bind="ctrl.info.title"></span> <span class="md-subhead"
				ng-bind="ctrl.info.description"></span> <md-card-title-media
				ng-if="ctrl.header.show_logos" layout="row" flex="auto"
				layout-padding> <img class="md-media-sm"
				style="height: 100px;"
				ng-src="http://galaxy.cineca.it/micco/fusion-form/app/assets/logo_cineca.png"
				alt="logo1"> <img class="md-media-sm" ng-src="logo_negri.png"
				alt="logo2"> </md-card-title-media> </md-card-title-text> </md-card-title> </md-card> </md-content>
		</section>

		<div ng-include="ctrl.page"></div>
	</div>
</body>
</html>
